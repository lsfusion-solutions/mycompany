MODULE SalesPricelistValue;

REQUIRE SalesPricelistDone;

NAMESPACE Sales;

// prices
pricelistLineB (PriceType t, Item i, DATETIME d) = 
    GROUP LAST PricelistLine prl IF item(prl) = i AND price(prl, t) AND done(pricelist(prl)) AND 
               NOT startDateTime(pricelist(prl)) >= d AND NOT endDateTime(pricelist(prl)) < d
          ORDER startDateTime(pricelist(prl)), prl;

priceB (PriceType t, Item i, DATETIME d) = price(pricelistLineB(t, i, d), t);

pricelistLineA (PriceType t, Item i, DATETIME d) = 
    GROUP LAST PricelistLine prl IF item(prl) = i AND price(prl, t) AND done(pricelist(prl)) AND
               NOT startDateTime(pricelist(prl)) > d AND NOT endDateTime(pricelist(prl)) < d
          ORDER startDateTime(pricelist(prl)), prl;

priceA (PriceType t, Item i, DATETIME d) = price(pricelistLineA(t, i, d), t);

overPriceA (PriceType t, Item i, DATETIME d) = OVERRIDE priceA(t, i, d), salesPrice(i);

// prices for lines
currentPrice (PricelistLine l, PriceType t) = priceB(t, item(l), startDateTime(pricelist(l)));

currentPriceColor (PricelistLine l, PriceType t) = 
    IF currentPrice(l, t) < price(l, t) 
        THEN RGB(187,242,210) 
        ELSE IF currentPrice(l, t) > price(l, t) THEN RGB(250,150,157);

EXTEND FORM pricelist
    PROPERTIES    currentPrice(l, t) COLUMNS 'p' (t) HEADER name(t) + ' (текущая)' 
                        SHOWIF showCurrentPrice(type(p)) AFTER price(l, t) BACKGROUND currentPriceColor(l, t)
;